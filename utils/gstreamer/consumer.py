"""
================================================================================
ğŸ–¥ï¸ Consumer æ¶æ§‹è¨­è¨ˆ 2025.08.21
================================================================================

Consumer æ¡ç”¨å–®ä¸€è·è²¬åŸå‰‡è¨­è¨ˆï¼Œå°ˆè²¬æ¨è«–çµæœçš„é¡¯ç¤ºã€è¼¸å‡ºèˆ‡æ€§èƒ½ç›£æ§ã€‚
æ”¯æ´ Videoï¼ˆå®Œæ•´æ€§å„ªå…ˆï¼‰èˆ‡ Cameraï¼ˆå¯¦æ™‚æ€§å„ªå…ˆï¼‰å…©ç¨®æ¨¡å¼ï¼Œä¸¦æ ¹æ“šæ¨¡å¼è‡ªå‹•èª¿æ•´é¡¯ç¤ºç·©è¡èˆ‡ä¸Ÿå¹€ç­–ç•¥ã€‚

ğŸ¯ æ ¸å¿ƒçµ„ä»¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“¸ Video    â”‚ å®Œæ•´æ€§å„ªå…ˆ       â”‚ é †åºé¡¯ç¤ºã€ç„¡ä¸Ÿå¹€ã€é€²åº¦è¿½è¹¤              â”‚
â”‚ ğŸ“· Camera   â”‚ å¯¦æ™‚æ€§å„ªå…ˆ       â”‚ æ™ºèƒ½ä¸Ÿå¹€ã€ä½å»¶é²ã€FPSè‡ªé©æ‡‰            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“Š è³‡æ–™æµå‘ï¼š
    Results â”€â”€> Consumerï¼ˆé¡¯ç¤º/è¼¸å‡º/çµ±è¨ˆï¼‰

ğŸ¯ æ ¸å¿ƒæ¶æ§‹ï¼š
Consumerï¼ˆé¡¯ç¤ºèˆ‡è¼¸å‡ºå–®å…ƒï¼‰
â”œâ”€â”€ é¡¯ç¤ºç·©è¡ç®¡ç†ï¼ˆæ ¹æ“šæ¨¡å¼è‡ªå‹•èª¿æ•´ï¼‰
â”œâ”€â”€ FPSèˆ‡å»¶é²ç›£æ§
â”œâ”€â”€ å¤šåŸ·è¡Œç·’é¡¯ç¤ºå¾ªç’°
â””â”€â”€ çµ±è¨ˆè³‡æ–™å›å ±

ğŸ“Š è·è²¬åˆ†é…ï¼ˆâ—¯ = æä¾›æ¡†æ¶ / âœ… = å…·é«”å¯¦ä½œï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åŠŸèƒ½é¡åˆ¥      â”‚  Videoæ¨¡å¼ç‰¹æ€§      â”‚ Cameraæ¨¡å¼ç‰¹æ€§  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ–¼ï¸ é¡¯ç¤ºç·©è¡     â”‚ âœ… é †åºé¡¯ç¤ºã€ç„¡ä¸Ÿå¹€ â”‚ âœ… æ™ºèƒ½ä¸Ÿå¹€ã€ä½å»¶é² â”‚
â”‚ ğŸ¯ FPSç›£æ§      â”‚ âœ… é€²åº¦è¿½è¹¤        â”‚ âœ… FPSè‡ªé©æ‡‰      â”‚
â”‚ ğŸ§¹ è³‡æºç®¡ç†     â”‚ âœ… ç·šç¨‹å®‰å…¨æ¸…ç†    â”‚ âœ… ç·šç¨‹å®‰å…¨æ¸…ç†    â”‚
â”‚ ğŸ“Š çµ±è¨ˆå›å ±     â”‚ âœ… é¡¯ç¤ºçµ±è¨ˆ        â”‚ âœ… é¡¯ç¤ºçµ±è¨ˆ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ”§ æ ¸å¿ƒç‰¹æ€§ï¼š
â€¢ æ ¹æ“šæ¨¡å¼è‡ªå‹•èª¿æ•´é¡¯ç¤ºç·©è¡å€å¤§å°èˆ‡ä¸Ÿå¹€ç­–ç•¥
â€¢ æ”¯æ´å¤šåŸ·è¡Œç·’é¡¯ç¤ºå¾ªç’°ï¼Œç¢ºä¿ä¸»æµç¨‹ä¸å¡é “
â€¢ å…§å»ºFPSèˆ‡å»¶é²ç›£æ§ï¼Œä¾¿æ–¼æ€§èƒ½åˆ†æ
â€¢ å¯èˆ‡Producer/WorkerPooléˆæ´»çµ„åˆï¼Œæ”¯æ´å¤šç¨®ä¸²æµå ´æ™¯

ğŸ› ï¸ é–‹ç™¼æç¤ºï¼š
â€¢ æ–°å¢é¡¯ç¤ºæ¨¡å¼æ™‚ï¼Œæ“´å……é¡¯ç¤ºç·©è¡èˆ‡ä¸Ÿå¹€ç­–ç•¥åˆ†æ”¯
â€¢ å¯æ ¹æ“šéœ€æ±‚æ“´å……çµ±è¨ˆè³‡æ–™å›å ±æ ¼å¼
â€¢ æ³¨æ„Videoæ¨¡å¼ä¸‹å®Œæ•´æ€§ï¼ŒCameraæ¨¡å¼ä¸‹å³æ™‚æ€§
"""

import cv2
import time
from collections import deque

# ä½¿ç”¨èˆ‡ pipeline ç›¸åŒçš„ logger
 # ...existing code...

import threading

class Consumer:
    def __init__(self, window_name="", monitor=None, display_size=None, fps=30, mode='camera', producer=None):
    # ...existing code...
        self.window_name = window_name
        self.monitor = monitor
        self.display_size = display_size
        self.fps = fps
        self.frame_count = 0
        self.display_times = deque(maxlen=30)
        self.current_fps = 0.0
        self.mode = mode
        self.producer = producer  # æ–°å¢ï¼šç”¨æ–¼ç²å–åŸå§‹video fps
        if mode == 'video':
            self.display_buffer = deque(maxlen=50)
        else:
            self.display_buffer = deque(maxlen=1)
        self.display_buffer_lock = threading.Lock()
        self._running = threading.Event()
        self._running.set()
        self._thread = None

        # æ·»åŠ fpsè¿½è¹¤è®Šæ•¸
        self.display_counter = 0
        self.last_display_fps_time = time.time()
        self.fps_check_interval = 30  # æ¯30å¹€æª¢æŸ¥ä¸€æ¬¡å¯¦éš›é¡¯ç¤ºfps
        self.buffer_size_log_counter = 0  # buffer sizeè¨˜éŒ„è¨ˆæ•¸å™¨

        # åˆå§‹åŒ–æ—¥èªŒ
        import logging
        logger = logging.getLogger('gstreamer_demo')
        logger.info("ğŸ–¥ï¸ " + "="*60)
        logger.info("ğŸ–¥ï¸ Consumeråˆå§‹åŒ–é–‹å§‹")
        logger.info("ğŸ–¥ï¸ " + "="*60)
        logger.info(f"ğŸ“‹ æ­¥é©Ÿ 1/2: ğŸš€ é¡¯ç¤ºç·©è¡å€é…ç½®...")
        logger.info(f"ğŸ” [{self.mode.upper()}] è¦–çª—åç¨±: {self.window_name}")
        logger.info(f"ğŸ” [{self.mode.upper()}] é¡¯ç¤ºç·©è¡å€å¤§å°: {self.display_buffer.maxlen}")
        logger.info(f"ğŸ” [{self.mode.upper()}] ç›®æ¨™FPS: {self.fps}")
        logger.info(f"ğŸ“‹ æ­¥é©Ÿ 2/2: âš™ï¸ é¡¯ç¤ºåŸ·è¡Œç·’èˆ‡çµ±è¨ˆåˆå§‹åŒ–...")
        logger.info(f"ğŸ“Š [{self.mode.upper()}] é¡¯ç¤ºå°ºå¯¸: {self.display_size if self.display_size else 'åŸå§‹å¤§å°'}")
        logger.info(f"ğŸ“Š [{self.mode.upper()}] FPSçµ±è¨ˆé–“éš”: {self.fps_check_interval} å¹€")
        logger.info(f"âœ… Consumeråˆå§‹åŒ–å®Œæˆ!")
        logger.info("ğŸ–¥ï¸ " + "="*60)

    def start_display(self):
        if self._thread is None:
            self._thread = threading.Thread(target=self._display_loop, daemon=True)
            self._thread.start()

    def stop_display(self):
        self._running.clear()
        if self._thread is not None:
            self._thread.join()
            self._thread = None

    def put_frame(self, frame):
        with self.display_buffer_lock:
            if self.mode == 'video':
                # video mode: ç¢ºä¿ä¸ä¸Ÿå¹€ï¼Œé©ç•¶ç­‰å¾… buffer ç©ºé–“
                while len(self.display_buffer) >= self.display_buffer.maxlen:
                    time.sleep(0.001)  # çŸ­æš«ç­‰å¾…ï¼Œé¿å…ä¸Ÿå¹€
            else:
                # camera mode: ä¿æŒåŸæœ‰é‚è¼¯ï¼Œå…è¨±ä¸Ÿå¹€
                if len(self.display_buffer) == self.display_buffer.maxlen:
                    pass
            self.display_buffer.append(frame)

    def _display_loop(self):
        # å‹•æ…‹è¨­å®šé¡¯ç¤ºé–“éš”ï¼švideo modeä½¿ç”¨åŸå§‹fpsï¼Œcamera modeä½¿ç”¨è¨­å®šfps
        if self.mode == 'video' and self.producer and hasattr(self.producer, 'get_fps'):
            target_fps = self.producer.get_fps()
            interval = 1.0 / target_fps
        else:
            interval = 1.0 / self.fps
        
        last_frame = None
        frames_without_new = 0  # è¨ˆç®—é€£çºŒæ²’æœ‰æ–°å¹€çš„æ¬¡æ•¸
        
        while self._running.is_set():
            time.sleep(interval)
            frame = None
            
            with self.display_buffer_lock:
                if self.mode == 'video':
                    # video mode: ä¾åºé¡¯ç¤ºæ‰€æœ‰ frame
                    if self.display_buffer:
                        frame = self.display_buffer.popleft()
                        frames_without_new = 0
                    else:
                        frames_without_new += 1
                else:
                    # camera mode: åªé¡¯ç¤ºæœ€æ–° frame
                    while self.display_buffer:
                        frame = self.display_buffer.popleft()
                        frames_without_new = 0
            
            # é¸æ“‡è¦é¡¯ç¤ºçš„å¹€
            display_frame = frame if frame is not None else last_frame
            
            # Video mode: å¦‚æœé€£çºŒè¶…é 30 å¹€(1ç§’)éƒ½æ²’æœ‰æ–°å¹€ï¼Œåœæ­¢é‡è¤‡é¡¯ç¤º
            if self.mode == 'video' and frames_without_new > 30:
                display_frame = None
            
            if display_frame is not None:
                self.display_counter += 1
                try:
                    disp_frame = display_frame
                    if self.display_size is not None:
                        disp_frame = cv2.resize(disp_frame, self.display_size)
                    if self.monitor:
                        self.monitor.draw_info(disp_frame)
                    cv2.imshow(self.window_name, disp_frame)
                    
                    # Video mode: åªåœ¨é¡¯ç¤ºæ–°å¹€æ™‚æ‰è¨ˆæ•¸ï¼Œé¿å…é‡è¤‡è¨ˆæ•¸
                    if self.monitor and (frame is not None or self.mode == 'camera'):
                        self.monitor.count_consumed()
                        
                    if cv2.waitKey(1) & 0xFF == ord('q'):
                        self.stop_display()
                        break
                        
                    # å®šæœŸè¨˜éŒ„é¡¯ç¤ºfps
                    if self.display_counter % self.fps_check_interval == 0:
                        current_time = time.time()
                        actual_interval = (current_time - self.last_display_fps_time) / self.fps_check_interval
                        actual_display_fps = 1.0 / actual_interval if actual_interval > 0 else 0
                        
                        pass
                        self.last_display_fps_time = current_time
                        
                except Exception as e:
                    pass
            
            # æ›´æ–° last_frame åªåœ¨æœ‰æ–°å¹€æ™‚
            if frame is not None:
                last_frame = frame
        
        # æ¸…ç†CV2çª—å£
        cv2.destroyWindow(self.window_name)