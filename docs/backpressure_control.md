# èƒŒå£“æ§åˆ¶ç³»çµ±å„ªåŒ–

## ğŸ¯ è§£æ±ºçš„å•é¡Œ

åŸå§‹å•é¡Œï¼šå¤š worker ç’°å¢ƒä¸‹å‡ºç¾æ‰¹æ¬¡è™•ç†æ•ˆæ‡‰
```
æ™‚é–“è»¸: t0-t4  å¿«é€Ÿå–æ¨£ ğŸ“¸ğŸ“¸ğŸ“¸ğŸ“¸ğŸ“¸
        t5-t15 å…¨éƒ¨è™•ç†ä¸­ â³â³â³â³â³  
        t16    çªç„¶è¼¸å‡º   ğŸ’»ğŸ’»ğŸ’»ğŸ’»ğŸ’»
```

å„ªåŒ–å¾Œï¼šå¹³æ»‘çš„è¼¸å…¥è¼¸å‡ºæµç¨‹
```
æ™‚é–“è»¸: t0  t2  t4  t6  t8  t10 t12 t14
å–æ¨£:   ğŸ“¸   ğŸ“¸   ğŸ“¸   ğŸ“¸   ğŸ“¸   ğŸ“¸   ğŸ“¸   ğŸ“¸
è™•ç†:    âš™ï¸   âš™ï¸   âš™ï¸   âš™ï¸   âš™ï¸   âš™ï¸   âš™ï¸
è¼¸å‡º:     ğŸ’»   ğŸ’»   ğŸ’»   ğŸ’»   ğŸ’»   ğŸ’»   ğŸ’»
```

## ğŸ”§ æ ¸å¿ƒæ©Ÿåˆ¶

### 1. èƒŒå£“æ§åˆ¶ (Backpressure Control)
```python
def _should_drop_frame(self):
    busy_workers = sum(1 for worker in self.workers if worker.is_busy)
    queue_size = self.task_queue.qsize() 
    total_load = busy_workers + queue_size
    
    # ç•¶è² è¼‰è¶…é 80% æ™‚é–‹å§‹ä¸Ÿå¹€
    return total_load >= (self.max_workers * 0.8)
```

### 2. å‡å‹»æ´¾å·¥é–“éš”
```python
# æ ¹æ“š worker æ•¸é‡å‹•æ…‹èª¿æ•´æ´¾å·¥é–“éš”
base_interval = self.balancer.get_producer_sleep(self.process_interval)
self.process_interval = base_interval / max(1, self.max_workers - 2)
```

### 3. ç°¡åŒ–çµæœè™•ç†
- ç§»é™¤è¤‡é›œçš„é †åºç·©è¡æ©Ÿåˆ¶
- ä¾é èƒŒå£“æ§åˆ¶è‡ªç„¶ä¿è­‰ç›¸å°é †åº
- æ¸›å°‘è™•ç†å»¶é²

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨
```bash
# å•Ÿç”¨èƒŒå£“æ§åˆ¶ï¼ˆé è¨­ï¼‰
python gstreamer_demo.py --max_workers 4

# åœç”¨å¹³è¡¡å™¨ï¼ˆä¸æ¨è–¦ï¼‰
python gstreamer_demo.py --max_workers 4 --disable_balancer

# å•Ÿç”¨è©³ç´°èƒŒå£“æ—¥èªŒ
python gstreamer_demo.py --max_workers 4 --enable_backpressure_logging
```

### æ¸¬è©¦æ•ˆæœ
```bash
# åŸ·è¡Œè‡ªå‹•åŒ–æ¸¬è©¦
python test_backpressure.py
```

## ğŸ“Š é æœŸæ•ˆæœ

### æ”¹å–„æŒ‡æ¨™
- âœ… **å¹³è¡¡å™¨èª¿æ•´é »ç‡é™ä½**: æ¸›å°‘ 50-80% çš„èª¿æ•´æ¬¡æ•¸
- âœ… **è™•ç†æµç¨‹æ›´å¹³æ»‘**: é¿å…æ‰¹æ¬¡è™•ç†æ•ˆæ‡‰
- âœ… **é¡¯ç¤ºæ›´ç©©å®š**: æ¸›å°‘å¿½å¿«å¿½æ…¢çš„ç¾è±¡
- âœ… **ç³»çµ±è² è¼‰å¹³è¡¡**: CPU ä½¿ç”¨æ›´å‡å‹»

### ç›£æ§æŒ‡æ¨™
- `Load: X.X%` - ç³»çµ±è² è¼‰ç™¾åˆ†æ¯”
- `Backpressure: ON/OFF` - èƒŒå£“æ§åˆ¶ç‹€æ…‹
- `dropping frame to prevent batching` - èƒŒå£“ä¸Ÿå¹€æ—¥èªŒ

## ğŸ” èª¿è©¦å’Œèª¿å„ª

### æŸ¥çœ‹ç³»çµ±ç‹€æ…‹
```python
# åœ¨ç¨‹å¼ä¸­å¯ä»¥é€™æ¨£æª¢æŸ¥
worker_pool = WorkerPool(...)
status = worker_pool.get_status()
print(f"ç³»çµ±è² è¼‰: {status['load_percentage']}%")
print(f"èƒŒå£“æ˜¯å¦å•Ÿå‹•: {status['backpressure_active']}")
```

### èª¿æ•´åƒæ•¸
```python
# åœ¨ _should_drop_frame æ–¹æ³•ä¸­èª¿æ•´é–¾å€¼
load_threshold = self.max_workers * 0.8  # é è¨­ 80%

# å¯ä»¥æ ¹æ“šéœ€è¦èª¿æ•´ç‚ºï¼š
load_threshold = self.max_workers * 0.6  # æ›´ä¿å®ˆ (60%)
load_threshold = self.max_workers * 0.9  # æ›´æ¿€é€² (90%)
```

## ğŸ›ï¸ é©ç”¨å ´æ™¯

### âœ… é©åˆçš„æƒ…æ³
- Worker æ•¸é‡è¼ƒå°‘ (2-8 å€‹)
- è™•ç†é€Ÿåº¦ä¸å‡å‹»
- éœ€è¦å¹³æ»‘é¡¯ç¤ºæ•ˆæœ
- å¯¦æ™‚æ€§è¦æ±‚é«˜

### âš ï¸ éœ€è¦æ³¨æ„çš„æƒ…æ³  
- éå¸¸é«˜çš„ FPS éœ€æ±‚ (å¯èƒ½éœ€è¦èª¿æ•´ä¸Ÿå¹€ç­–ç•¥)
- æ¯ä¸€å¹€éƒ½å¾ˆé‡è¦çš„å ´æ™¯ (å¯ä»¥åœç”¨èƒŒå£“æ§åˆ¶)
- è™•ç†èƒ½åŠ›é è¶…è¼¸å…¥é€Ÿåº¦æ™‚ (èƒŒå£“æ§åˆ¶ä¸æœƒå•Ÿå‹•)

## ğŸ› æ•…éšœæ’é™¤

### å•é¡Œï¼šèƒŒå£“æ§åˆ¶æ²’æœ‰å•Ÿå‹•
**ç¾è±¡**: æ—¥èªŒä¸­æ²’æœ‰ "dropping frame" è¨Šæ¯
**å¯èƒ½åŸå› **: ç³»çµ±è² è¼‰ä¸å¤ é«˜ï¼Œè™•ç†èƒ½åŠ›è¶³å¤ 
**è§£æ±º**: æ­£å¸¸ç¾è±¡ï¼Œä»£è¡¨ç³»çµ±æ€§èƒ½è‰¯å¥½

### å•é¡Œï¼šä¸Ÿå¹€å¤ªå¤š
**ç¾è±¡**: å¤§é‡ "System overloaded" è¨Šæ¯
**å¯èƒ½åŸå› **: Worker æ•¸é‡å¤ªå°‘æˆ–è™•ç†å¤ªæ…¢
**è§£æ±º**: å¢åŠ  worker æ•¸é‡æˆ–ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹

### å•é¡Œï¼šé¡¯ç¤ºä»ç„¶ä¸å¹³æ»‘
**ç¾è±¡**: ä»æœ‰æ‰¹æ¬¡è™•ç†æ•ˆæ‡‰
**å¯èƒ½åŸå› **: æ´¾å·¥é–“éš”è¨­å®šä¸ç•¶
**è§£æ±º**: èª¿æ•´ `self.process_interval` è¨ˆç®—å…¬å¼
